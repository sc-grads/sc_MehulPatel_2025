name: Testing

on:
  workflow_dispatch:

jobs:
  deploy-and-run:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set PowerShell Execution Policy
        shell: powershell
        run: |
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      - name: Ensure SSISDB exists
        shell: powershell
        run: |
          $dbExists = Invoke-Sqlcmd -ServerInstance "localhost" -Database "master" -Query "SELECT DB_ID('SSISDB') AS DbId"
          if (-not $dbExists.DbId) {
              Write-Host "SSISDB does not exist. Creating..."
              # Create SSISDB database
              Invoke-Sqlcmd -ServerInstance "localhost" -Database "master" -Query "CREATE DATABASE SSISDB"
              # Enable CLR required for SSIS catalog
              Invoke-Sqlcmd -ServerInstance "localhost" -Database "master" -Query "EXEC sp_configure 'clr enabled', 1; RECONFIGURE;"
              Write-Host "SSISDB database created. Please ensure catalog is initialized via SSMS once."
          } else {
              Write-Host "SSISDB already exists."
          }

      - name: Create SSIS Folder
        shell: cmd
        run: |
          sqlcmd -S localhost -d SSISDB -E -Q "IF NOT EXISTS (SELECT * FROM [catalog].[folders] WHERE name='TimesheetProject') EXEC [catalog].[create_folder] @folder_name='TimesheetProject'"

      - name: Deploy SSIS Package using SSISDeploy
        shell: cmd
        run: |
          C:\DevopTools\SSISDeploy.exe -s:C:\Repositories\sc_MehulPatel_2025\DatabaseAdministration\HandsOnProject\Timesheet\TimesheetProject.ispac ^
          -d:CATALOG;/SSISDB/TimesheetProject/TimesheetProject;localhost ^
          -authType:WIN
